<div class="container-fluid">
    <div class="row mt-3">
        <div class="col">

            <form>
                <div class="form-group row">
                    <label for="settingsLogPath" class="col-sm-2 col-form-label">Log Path</label>
                    <div class="col-sm-10">
                        <input type="text" name="logpath" class="form-control" id="settingsLogPath"
                               value="{{ logpath }}">
                    </div>
                </div>

                <div class="form-group row">
                    <label for="listensniffers" class="col-sm-2 col-form-label">Listen for Sniffers</label>
                    <div class="col-sm-10">
                        <label>
                            <input type="checkbox" name="listensniffers" data-toggle="toggle"
                                   data-size="sm" {{ listensniffers }}>
                        </label>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="inputPassword" class="col-sm-2 col-form-label">Port for Sniffers</label>
                    <div class="col-sm-10">
                        <input type="text" readonly name="listenport" class="form-control-plaintext"
                               id="settingsLogPath" value="{{ listenport }}">
                    </div>
                </div>

                <div class="form-group row">
                    <label for="simulator" class="col-sm-2 col-form-label">Message Simulator</label>
                    <div class="col-sm-10">
                        <label>
                            <input type="checkbox" name="simulator" data-toggle="toggle"
                                   data-size="sm" {{ simulator }}>
                        </label>
                    </div>
                </div>

            </form>

        </div>


    </div>
    <div class="col fixed-bottom text-center pt-5 mt-5">
        <small><pre>Settings are autosaved. Just stop typing.</pre></small>
    </div>
</div>

<script src></script>
<script>

    let timeout = null;

    $('input[type=text]').on('keyup', function () {

        var that = this;
        if (timeout !== null) {
            clearTimeout(timeout);
        }

        timeout = setTimeout(function () {

            var post_data = {
                'key': $(that).attr('name'),
                'value': $(that).val(),
                'csrfmiddlewaretoken': "{{ csrf_token }}"

            }
            $.ajax({
                type: 'POST',
                url: "{% url 'appsettings-save-setting' %}",
                data: post_data,
                error: (e) => {
                    $.toast({
                        type: 'error',
                        title: 'Error',
                        content: 'Could not save setting. Error: ' + e.status + ' ' + e.statusText + '. ',
                        delay: 5000
                    });
                },
                success: (d) => {
                    $.toast({
                        type: 'success',
                        title: 'Setting Saved',
                        content: 'New value for ' + d.key + ' is ' + d.value,
                        delay: 5000
                    });
                },
                dataType: "json"
            });

        }, 1000);
    });

    $('input[type=checkbox]').change(function () {

        var that = this;
        if (timeout !== null) {
            clearTimeout(timeout);
        }

        timeout = setTimeout(function () {

            let value = ""

            if (that.checked) {
                value = "checked"
            }


            var post_data = {
                'key': $(that).attr('name'),
                'value': value,
                'csrfmiddlewaretoken': "{{ csrf_token }}"

            }
            $.ajax({
                type: 'POST',
                url: "{% url 'appsettings-save-setting' %}",
                data: post_data,
                error: (e) => {
                    $.toast({
                        type: 'error',
                        title: 'Error',
                        content: 'Could not save setting. Error: ' + e.status + ' ' + e.statusText + '. ',
                        delay: 5000
                    });
                },
                success: (d) => {

                    var state = "off";
                    if(that.checked){
                        state = "on"
                    }

                    $.toast({
                        type: 'success',
                        title: 'Setting Saved',
                        content: 'Set Status for  ' + d.key + ' to ' + state,
                        delay: 5000
                    });
                },
                dataType: "json"
            });

        }, 1);
    });

</script>